// atualizarUsuariosPlano.js
// Coloque na pasta: acessivision-backend/atualizarUsuariosPlano.js

import admin from "firebase-admin";
import { readFileSync } from "fs";

// Importa credenciais
const serviceAccount = JSON.parse(
  readFileSync("./acessivision-firebase-adminsdk.json", "utf8")
);

// Inicializar Firebase Admin
if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount)
  });
}

const db = admin.firestore();

// ==========================================
// ATUALIZAR TODOS OS USU√ÅRIOS
// ==========================================
async function atualizarUsuarios() {
  console.log('\nüîÑ ATUALIZANDO USU√ÅRIOS COM CAMPOS DE PLANO...\n');

  try {
    const usuariosRef = db.collection('usuarios');
    const snapshot = await usuariosRef.get();

    if (snapshot.empty) {
      console.log('‚ö†Ô∏è  Nenhum usu√°rio encontrado');
      return;
    }

    console.log(`üìä Total de usu√°rios: ${snapshot.size}\n`);

    let atualizados = 0;
    let jaExistiam = 0;

    for (const doc of snapshot.docs) {
      const data = doc.data();
      
      // Verificar se j√° tem os campos
      if (data.plano && data.planoExpiracao !== undefined) {
        console.log(`‚úì ${doc.id} - J√° possui campos de plano (${data.plano})`);
        jaExistiam++;
        continue;
      }

      // Adicionar campos
      await doc.ref.update({
        plano: 'free',
        planoExpiracao: null,
        atualizarPerfilDados: admin.firestore.Timestamp.now()
      });

      console.log(`‚úÖ ${doc.id} - Atualizado com plano FREE`);
      atualizados++;
    }

    console.log('\n' + '='.repeat(60));
    console.log(`‚úÖ Usu√°rios atualizados: ${atualizados}`);
    console.log(`‚ÑπÔ∏è  J√° possu√≠am campos: ${jaExistiam}`);
    console.log(`üìä Total: ${snapshot.size}`);
    console.log('='.repeat(60) + '\n');

  } catch (error) {
    console.error('‚ùå Erro ao atualizar usu√°rios:', error);
  }

  process.exit(0);
}

// ==========================================
// ATUALIZAR UM USU√ÅRIO ESPEC√çFICO PARA PREMIUM (TESTE)
// ==========================================
async function testarPremium(uid) {
  console.log(`\nüéØ ATUALIZANDO USU√ÅRIO ${uid} PARA PREMIUM...\n`);

  try {
    const usuarioRef = db.collection('usuarios').doc(uid);
    const doc = await usuarioRef.get();

    if (!doc.exists) {
      console.log('‚ùå Usu√°rio n√£o encontrado');
      return;
    }

    // Definir expira√ß√£o para 30 dias a partir de hoje
    const dataExpiracao = new Date();
    dataExpiracao.setDate(dataExpiracao.getDate() + 30);

    await usuarioRef.update({
      plano: 'premium',
      planoExpiracao: admin.firestore.Timestamp.fromDate(dataExpiracao),
      atualizarPerfilDados: admin.firestore.Timestamp.now()
    });

    console.log('‚úÖ Usu√°rio atualizado para PREMIUM');
    console.log(`üìÖ Expira em: ${dataExpiracao.toLocaleDateString('pt-BR')}\n`);

  } catch (error) {
    console.error('‚ùå Erro:', error);
  }

  process.exit(0);
}

// ==========================================
// MENU
// ==========================================
const args = process.argv.slice(2);
const comando = args[0];

if (comando === 'premium' && args[1]) {
  testarPremium(args[1]);
} else if (comando === 'todos' || !comando) {
  atualizarUsuarios();
} else {
  console.log('\nüìö USO:\n');
  console.log('  node atualizarUsuariosPlano.js todos      - Atualiza todos para FREE');
  console.log('  node atualizarUsuariosPlano.js premium [UID] - Testa premium em um usu√°rio\n');
  console.log('Exemplos:\n');
  console.log('  node atualizarUsuariosPlano.js todos');
  console.log('  node atualizarUsuariosPlano.js premium E2U6ldvWu1VdNCusIRAxp2DSVIx1\n');
  process.exit(0);
}

// ==========================================
// COMO USAR:
// ==========================================
// 
// 1. Atualizar TODOS os usu√°rios para plano FREE:
//    node atualizarUsuariosPlano.js todos
//
// 2. Testar um usu√°rio espec√≠fico como PREMIUM:
//    node atualizarUsuariosPlano.js premium E2U6ldvWu1VdNCusIRAxp2DSVIx1
//
// ==========================================