// listarEstrutura.js
// Coloque este arquivo na raiz do backend: acessivision-backend/listarEstrutura.js

import admin from "firebase-admin";
import { readFileSync } from "fs";

// Importa credenciais da service account
const serviceAccount = JSON.parse(
  readFileSync("./acessivision-firebase-adminsdk.json", "utf8")
);

// Inicializar Firebase Admin (se j√° n√£o estiver inicializado)
if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount)
  });
}

const db = admin.firestore();

// ==========================================
// FUN√á√ÉO PRINCIPAL - LISTAR TUDO
// ==========================================
async function listarEstruturaCompleta() {
  console.log('\nüî• ESTRUTURA COMPLETA DO FIRESTORE DATABASE');
  console.log('='.repeat(80));
  console.log(`üìÖ Data: ${new Date().toLocaleString('pt-BR')}\n`);

  try {
    // Listar todas as cole√ß√µes
    const collections = await db.listCollections();
    
    console.log(`üìä Total de cole√ß√µes: ${collections.length}\n`);

    for (const collection of collections) {
      await listarColecao(collection);
    }

    console.log('\n' + '='.repeat(80));
    console.log('‚úÖ LISTAGEM COMPLETA FINALIZADA!\n');

  } catch (error) {
    console.error('‚ùå Erro ao listar estrutura:', error);
  }
}

// ==========================================
// LISTAR UMA COLE√á√ÉO ESPEC√çFICA
// ==========================================
async function listarColecao(collectionRef, nivel = 0) {
  const collectionName = collectionRef.id;
  const indent = '   '.repeat(nivel);
  
  console.log(indent + '‚îå' + '‚îÄ'.repeat(78 - (nivel * 3)) + '‚îê');
  console.log(indent + `‚îÇ üìÇ COLE√á√ÉO: ${collectionName.toUpperCase()}`.padEnd(79 - (nivel * 3)) + '‚îÇ');
  console.log(indent + '‚îî' + '‚îÄ'.repeat(78 - (nivel * 3)) + '‚îò');

  try {
    const snapshot = await collectionRef.get();
    
    console.log(indent + `   üìÑ Total de documentos: ${snapshot.size}`);

    if (snapshot.empty) {
      console.log(indent + '   ‚ö†Ô∏è  Cole√ß√£o vazia\n');
      return;
    }

    // Analisar estrutura dos documentos
    const campos = new Set();
    const tipos = {};
    
    snapshot.forEach(doc => {
      const data = doc.data();
      Object.keys(data).forEach(key => {
        campos.add(key);
        
        if (!tipos[key]) {
          tipos[key] = new Set();
        }
        tipos[key].add(typeof data[key]);
      });
    });

    // Mostrar estrutura
    console.log(indent + '\n   üìã Estrutura dos documentos:\n');
    
    Array.from(campos).sort().forEach(campo => {
      const tiposStr = Array.from(tipos[campo]).join(' | ');
      console.log(indent + `      ‚Ä¢ ${campo.padEnd(30)} : ${tiposStr}`);
    });

    // Mostrar exemplos de documentos (primeiros 3)
    console.log(indent + '\n   üìù Exemplos de documentos:\n');
    
    let count = 0;
    for (const doc of snapshot.docs) {
      if (count < 3) {
        console.log(indent + `      üÜî ID: ${doc.id}`);
        console.log(indent + `      üì¶ Dados:`);
        const data = doc.data();
        Object.keys(data).forEach(key => {
          let value = data[key];
          
          // Formatar timestamps
          if (value && typeof value.toDate === 'function') {
            value = value.toDate().toLocaleString('pt-BR');
          }
          
          // Limitar strings longas
          if (typeof value === 'string' && value.length > 50) {
            value = value.substring(0, 47) + '...';
          }

          console.log(indent + `         ${key}: ${JSON.stringify(value)}`);
        });
        
        // üî• LISTAR SUBCOLE√á√ïES DO DOCUMENTO
        const subcollections = await doc.ref.listCollections();
        if (subcollections.length > 0) {
          console.log(indent + `      üìÅ Subcole√ß√µes: ${subcollections.map(c => c.id).join(', ')}`);
          
          // Listar cada subcole√ß√£o recursivamente
          for (const subcol of subcollections) {
            console.log('');
            await listarColecao(subcol, nivel + 1);
          }
        }
        
        console.log('');
        count++;
      }
    }

    if (snapshot.size > 3) {
      console.log(indent + `      ... e mais ${snapshot.size - 3} documentos\n`);
    }

  } catch (error) {
    console.error(indent + `   ‚ùå Erro ao listar cole√ß√£o ${collectionName}:`, error);
  }

  console.log('');
}

// ==========================================
// EXPORTAR PARA JSON
// ==========================================
async function exportarParaJSON() {
  console.log('\nüíæ EXPORTANDO PARA JSON...\n');

  try {
    const collections = await db.listCollections();
    const estrutura = {};

    for (const collection of collections) {
      const collectionName = collection.id;
      const snapshot = await collection.get();
      
      estrutura[collectionName] = {
        total: snapshot.size,
        documentos: []
      };

      snapshot.forEach(doc => {
        estrutura[collectionName].documentos.push({
          id: doc.id,
          dados: doc.data()
        });
      });
    }

    // Salvar em arquivo
    const fs = await import('fs');
    const filename = `firestore-structure-${Date.now()}.json`;
    
    fs.writeFileSync(
      filename,
      JSON.stringify(estrutura, null, 2),
      'utf8'
    );

    console.log(`‚úÖ Estrutura exportada para: ${filename}\n`);

  } catch (error) {
    console.error('‚ùå Erro ao exportar:', error);
  }
}

// ==========================================
// GERAR RELAT√ìRIO RESUMIDO
// ==========================================
async function gerarRelatorioResumido() {
  console.log('\nüìä RELAT√ìRIO RESUMIDO\n');
  console.log('‚îÄ'.repeat(80));

  try {
    const collections = await db.listCollections();
    
    for (const collection of collections) {
      const snapshot = await collection.get();
      console.log(`üìÇ ${collection.id.padEnd(20)} : ${snapshot.size} documentos`);
    }

    console.log('‚îÄ'.repeat(80) + '\n');

  } catch (error) {
    console.error('‚ùå Erro ao gerar relat√≥rio:', error);
  }
}

// ==========================================
// MENU DE OP√á√ïES
// ==========================================
async function menu() {
  const args = process.argv.slice(2);
  const comando = args[0];

  switch (comando) {
    case 'completo':
    case 'full':
      await listarEstruturaCompleta();
      break;
    
    case 'resumo':
    case 'summary':
      await gerarRelatorioResumido();
      break;
    
    case 'export':
    case 'json':
      await exportarParaJSON();
      break;
    
    case 'colecao':
    case 'collection':
      const nomeColecao = args[1];
      if (!nomeColecao) {
        console.log('‚ùå Especifique o nome da cole√ß√£o: node listarEstrutura.js colecao usuarios');
        return;
      }
      const collectionRef = db.collection(nomeColecao);
      await listarColecao(collectionRef);
      break;
    
    default:
      console.log('\nüìö USO DO SCRIPT:\n');
      console.log('  node listarEstrutura.js [comando]\n');
      console.log('Comandos dispon√≠veis:\n');
      console.log('  completo, full     - Lista estrutura completa com exemplos');
      console.log('  resumo, summary    - Mostra apenas quantidade de docs por cole√ß√£o');
      console.log('  export, json       - Exporta tudo para arquivo JSON');
      console.log('  colecao [nome]     - Lista apenas uma cole√ß√£o espec√≠fica\n');
      console.log('Exemplos:\n');
      console.log('  node listarEstrutura.js completo');
      console.log('  node listarEstrutura.js resumo');
      console.log('  node listarEstrutura.js export');
      console.log('  node listarEstrutura.js colecao usuarios\n');
      
      // Se n√£o especificou comando, mostra resumo por padr√£o
      await gerarRelatorioResumido();
  }

  process.exit(0);
}

// Executar
menu().catch(console.error);

// ==========================================
// COMO USAR:
// ==========================================
// 
// 1. Salve este arquivo como: listarEstrutura.js
//    na pasta acessivision-backend
//
// 2. Execute um dos comandos:
//
//    # Ver estrutura completa
//    node listarEstrutura.js completo
//
//    # Ver apenas resumo
//    node listarEstrutura.js resumo
//
//    # Exportar para JSON
//    node listarEstrutura.js export
//
//    # Ver apenas uma cole√ß√£o
//    node listarEstrutura.js colecao usuarios
//
// ==========================================